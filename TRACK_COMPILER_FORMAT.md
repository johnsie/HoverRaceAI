# HoverCad Track Compiler Format Documentation

## Overview

HoverCad generates track files through the following pipeline:
1. User opens a `.TR` file in HoverCad (track designer)
2. User clicks "Compile"
3. HoverCad calls `GenerateOutputFile()` to create a temporary `.txt` file with specific format
4. HoverCad calls `MazeCompiler.exe <output.trk> <temp.txt>` to compile the track
5. The `.trk` file is saved to the user-specified location

## Temporary File Format

The temporary text file generated by HoverCad uses a structured format with sections. This document describes that format.

### File Structure

```
[Header]
Description=<track description>
Background=<path to background PCX file>

[Room]
Id=<room_id>
floor=<height>, <dll_id>, <texture_id>
ceiling=<height>, <dll_id>, <texture_id>
wall=<x>, <y>, <dll_id>, <texture_id>
wall=<x>, <y>, <dll_id>, <texture_id>
...

[Feature]
Id=<feature_id>
Parent=<parent_room_id>
floor=<height>, <dll_id>, <texture_id>
ceiling=<height>, <dll_id>, <texture_id>
wall=<x>, <y>, <dll_id>, <texture_id>
...

[Initial_Position]
Section=<room_id>
Position=<x>, <y>, <z>
Orientation=<angle>
Team=<team_number>

[Free_Element]
Section=<room_id>
Position=<x>, <y>, <z>
Orientation=<angle>
Element_Type=<dll_id>, <type_id>

[Connection_List]
<room1_id>, <wall1_id>, <room2_id>, <wall2_id>
<room1_id>, <wall1_id>, <room2_id>, <wall2_id>
...
```

### Section Details

#### [Header] Section
**Required**: Yes (but MazeCompiler can use defaults if missing)

- `Description`: Track description text. Supports `\n` for newlines (converted from `\r` in HoverCad).
- `Background`: Path to background PCX image file

**Example:**
```
[Header]
Description=Level: Easy\nLength: 0.6 km\nShort and fast track\nLots of curve and no jumps\n\n
Background=C:\originalhr\HoverRace\NetTarget\mazes\BG-CITY.pcx
```

#### [Room] Section
**Represents**: A 2D region of the track (rooms are connected to form the complete track)

- `Id`: Unique room identifier (integer)
- `floor`: Floor height, DLL ID, texture ID (space-separated, floating point for height)
- `ceiling`: Ceiling height, DLL ID, texture ID
- `wall`: X coordinate, Y coordinate, DLL ID, texture ID (multiple wall lines)

All coordinates are in game units (typically 1/1000 of actual meter).

**Example:**
```
[Room]
Id=1
floor= 0.000000, 1, 51
ceiling= 4.000000, 1, 50
wall=362.324000, 31.188000, 1, 52
wall=362.498000, 71.283000, 1, 69
wall=404.144000, 72.043000, 1, 53
wall=403.840000, 31.766000, 1, 52
```

#### [Feature] Section
**Represents**: A 3D feature/object within a room (optional)

- `Id`: Unique feature identifier
- `Parent`: ID of the parent room this feature belongs to (-1 if no valid parent)
- `floor`, `ceiling`, `wall`: Same format as Room section

**Example:**
```
[Feature]
Id=23
Parent=5
floor= 1.500000, 2, 100
ceiling= 3.500000, 2, 101
wall=350.000000, 50.000000, 2, 102
```

#### [Initial_Position] Section
**Represents**: Starting position for a racer/team

- `Section`: Room ID where racer starts
- `Position`: X, Y, Z coordinates (floating point)
- `Orientation`: Direction/angle the racer faces (in degrees, floating point)
- `Team`: Team/player number (1-10 typically)

**Example:**
```
[Initial_Position]
Section=1
Position= 392.591000, 56.610000, 0.000000
Orientation= 90.000000
Team= 1
```

#### [Free_Element] Section
**Represents**: Interactive objects placed on the track (power-ups, obstacles, etc.)

- `Section`: Room ID where element is placed
- `Position`: X, Y, Z coordinates
- `Orientation`: Element rotation angle
- `Element_Type`: DLL ID, Type ID (identifies what type of object this is)

**Example:**
```
[Free_Element]
Section=19
Position= 381.850000, 72.849000, 0.000000
Orientation= 0.000000
Element_Type= 1, 202
```

#### [Connection_List] Section
**Represents**: Connections between rooms (which rooms are adjacent/connected)

Each line format: `<room1_id>, <wall1_id>, <room2_id>, <wall2_id>`

- `room1_id`: First room ID
- `wall1_id`: Wall index in room1 (-1 if connection is disabled)
- `room2_id`: Adjacent room ID
- `wall2_id`: Wall index in room2 (-1 if connection is disabled)

The wall IDs are 0-based indices in the wall list for each room (in order walls are listed in the [Room] section).

**Example:**
```
[Connection_List]
1, 1, 19, 2
1, 3, 18, 4
2, 1, 3, 4
2, 3, 19, 0
```

This means:
- Room 1's wall 1 connects to Room 19's wall 2
- Room 1's wall 3 connects to Room 18's wall 4
- Room 2's wall 1 connects to Room 3's wall 4
- Room 2's wall 3 connects to Room 19's wall 0

## Texture/DLL IDs

The DLL ID and Type ID values reference textures and objects loaded from DLL files:
- **DLL ID 1**: Standard textures (floors, walls, ceilings from ColorTab.pal)
- **DLL ID 2+**: Special textures from other resource DLLs
- **Type ID**: Index into the texture list within that DLL

The **critical insight**: These IDs reference the palette indirectly. When the track was compiled, the ColorTab.pal file that was active at that time determined which palette entries were used. If the palette was grayscale when the track was compiled, the textures will render as grayscale regardless of later palette changes.

## HoverCad Debug Files

HoverCad saves debug copies of generated files for troubleshooting:

- **Temporary file location**: `%TEMP%\HC<XXXX>.tmp` (e.g., `HCA972.tmp`)
- **Debug file**: `%TEMP%\HC<XXXX>.tmp.debug` (copy for reference)
- **Compiler output log**: `%TEMP%\MazeCompiler_Output.log`

These debug files are valuable for understanding the exact format HoverCad generates.

## MazeCompiler Command Line

```
MazeCompiler <output_file.trk> <input_file.txt>
```

- Reads the text format from `input_file.txt`
- Generates binary track file `output_file.trk`
- Uses ColorTab.pal from the current directory for palette data

**Critical**: MazeCompiler reads the palette from `ColorTab.pal` in the directory where MazeCompiler.exe runs from. The palette data is embedded in the compiled `.trk` file.

## Important Notes

### Palette Encoding
When MazeCompiler compiles a track:
1. It reads texture IDs from the `.txt` file
2. It reads the color palette from `ColorTab.pal`
3. It embeds the palette data in the compiled `.trk` file
4. The game later uses this embedded palette to render textures

### Current Issue
The ClassicH.trk file was compiled when ColorTab.pal contained grayscale data. Even though the current ColorTab.pal is correct with colors, the compiled .trk file still contains the grayscale palette embedded in it.

### Solution
To fix colors:
1. Regenerate the `.txt` file from the `.TR` source (HoverCad does this automatically)
2. Recompile with `MazeCompiler output.trk input.txt`
3. Ensure ColorTab.pal contains proper colors when MazeCompiler runs

## Example Usage

```powershell
# Generate track.txt from HoverCad source (can be automated via script)
# Then compile:
cd C:\originalhr\HoverRace\Release
.\MazeCompiler.exe "..\Release\Tracks\ClassicH.trk" "C:\temp\ClassicH.txt"
```

The resulting `ClassicH.trk` will contain the current palette from `ColorTab.pal`.
