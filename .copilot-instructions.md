# HoverRace Project - Copilot Instructions

## Project Overview
HoverRace is a 3D racing game developed in C++ using DirectDraw for graphics rendering and MFC (Microsoft Foundation Classes) for the Windows UI. The project consists of multiple interdependent DLL libraries and the main Game2.exe application.

## Build System

### Environment
- **IDE:** Visual Studio 2022 Community
- **Toolset:** MSVC v143 (VC Tools 14.39.33519)
- **Target Platform:** Win32 (x86)
- **Configuration:** Release (default for builds)
- **Language:** C++ with MFC

### Rules
- Don't run the game in console mode. The game should run in windowed or fullscreen graphical mode to function correctly.


### Project Structure
```
c:\originalhr\HoverRace\
├── NetTarget\                    # Main development folder
│   ├── Game2\                    # Main application (Game2.exe)
│   ├── Util\                     # Core utilities DLL
│   ├── VideoServices\            # Graphics/video rendering DLL
│   ├── Model\                    # Game model and physics DLL
│   ├── MainCharacter\            # Player character system DLL
│   ├── ObjFacTools\              # Object factory tools DLL
│   └── ColorTools\               # Color management DLL
├── HoverCad\                     # CAD editor (separate project)
├── InternetRoom\                 # Server code (separate project)
└── Release\                      # Build output folder (all binaries go here)
    ├── Game2.exe                 # Main executable
    ├── Util.dll, VideoServices.dll, Model.dll, etc.
```

### Build Output
All compiled binaries are placed in the common `c:\originalhr\HoverRace\Release\` folder:
- **Game2.exe** - Main application (420.5 KB)
- **Util.dll** (103 KB)
- **VideoServices.dll** (278 KB)
- **Model.dll** (140 KB)
- **MainCharacter.dll** (94.5 KB)
- **ObjFacTools.dll** (137.5 KB)
- **ColorTools.dll** (78.5 KB)

**Important:** All DLLs must be in the same folder as Game2.exe for proper runtime loading.

### Project Dependencies
```
Game2.exe
├── Util.dll (must load first)
├── VideoServices.dll (depends on Util)
├── Model.dll (depends on Util, VideoServices)
├── MainCharacter.dll (depends on Util, VideoServices, Model)
├── ObjFacTools.dll (depends on Util, VideoServices, Model)
└── ColorTools.dll (depends on Util)
```

## Key Files and Locations

### Game2 Application Files
- `NetTarget/Game2/Game2.vcxproj` - Main project file
- `NetTarget/Game2/GameApp.cpp/h` - Main application class
- `NetTarget/Game2/Game2.rc` - Resource file (contains menus, dialogs, strings)
- `NetTarget/Game2/main.cpp` - Application entry point
- `NetTarget/Game2/TrackSelect.cpp/h` - Track selection dialog

### VideoServices Library
- `NetTarget/VideoServices/VideoServices.vcxproj` - Project file
- `NetTarget/VideoServices/VideoBuffer.cpp/h` - Core video buffer and display mode handling
- `NetTarget/VideoServices/VideoBuffer2DDraw.cpp` - 2D drawing operations
- `NetTarget/VideoServices/3DViewport.cpp/h` - 3D rendering viewport

### Resource Files
- `NetTarget/Game2/Game2.rc` - Main UI resources (menus, dialogs, icons, strings)
  - Contains FIREBALL_MAIN_MENU resource (ID 128) - the main menu bar

## Known Issues Fixed

### 1. Missing Menu Bar
**Issue:** Game2.exe had no top menu when launched
**Root Cause:** Game2.rc resource file was not being compiled into the executable
**Solution:** Verified Game2.vcxproj includes `<ResourceCompile Include="Game2.rc" />`
**Status:** ✅ FIXED

### 2. Video Mode Forcing 256-Color
**Issue:** Application tried to force 256-color (8-bit) mode on startup (outdated for modern systems)
**Root Cause:** Hardcoded 8-bit color depth in `VideoBuffer.cpp` functions:
- Line 345: `TryToSet256ColorMode()` called `SetDisplayMode(..., 8)`
- Line 861: `SetVideoMode()` called `SetDisplayMode(..., 8)`
**Solution:** Modified both functions to use 32-bit color (fallback to 16-bit if needed)
**Status:** ✅ FIXED

### 3. DLL Output Directories
**Issue:** DLLs were being built to individual project folders, causing Game2.exe to fail finding them at runtime
**Root Cause:** Output directories used relative `$(SolutionDir)` which resolved to NetTarget folder instead of root
**Solution:** Changed all DLL projects to use absolute path: `c:\originalhr\HoverRace\Release\`
**Status:** ✅ FIXED

## Building the Project

### Full Clean Build
```powershell
# Clean all artifacts
Remove-Item "c:\originalhr\HoverRace\Release" -Recurse -Force -ErrorAction SilentlyContinue
Get-ChildItem "c:\originalhr\HoverRace\NetTarget\*\Release" -Recurse -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

# Build all DLLs
$msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
foreach ($dll in @("Util", "VideoServices", "Model", "MainCharacter", "ObjFacTools", "ColorTools")) {
  & $msbuild "c:\originalhr\HoverRace\NetTarget\$dll\$dll.vcxproj" /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v143 /v:quiet
}

# Build main executable
& $msbuild "c:\originalhr\HoverRace\NetTarget\Game2\Game2.vcxproj" /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v143 /v:quiet
```

### Quick Build Single Component
```powershell
$msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
& $msbuild "c:\originalhr\HoverRace\NetTarget\VideoServices\VideoServices.vcxproj" /p:Configuration=Release /p:Platform=Win32 /p:PlatformToolset=v143 /v:quiet
```

### Running the Application
```powershell
& "c:\originalhr\HoverRace\Release\Game2.exe"
```

## Code Standards

### File Encoding
- Use ASCII/UTF-8 (no BOM)
- Line endings: CRLF (Windows style)

### Header Files
- Always include guards or #pragma once
- Include order: system headers first, then project headers
- Example:
```cpp
#pragma once

#include <windows.h>
#include <ddraw.h>
#include "VideoBuffer.h"
```

### Resource Files (.rc)
- Maintain menu structure in Game2.rc
- Dialog definitions should use clear resource IDs
- String resources should be in `IDS_*` format
- Icons and cursors stored in `res/` subfolder

### C++ Style
- MFC conventions where applicable
- CamelCase for class names (e.g., `MR_VideoBuffer`)
- Snake_case for constants and macros (e.g., `DDSCL_EXCLUSIVE`)
- Function naming: descriptive names with prefixes (e.g., `Set`, `Get`, `Try`)

## Video Mode Architecture

### DirectDraw Initialization
- Primary surface created with DDSCAPS_PRIMARYSURFACE
- Back buffer created with DDSCAPS_OFFSCREENPLAIN
- Palette support for legacy compatibility (rarely used in modern builds)

### Bit Depth Support
- **Preferred:** 32-bit (truecolor)
- **Fallback:** 16-bit (65k colors)
- **Legacy (no longer used):** 8-bit (256-color with palette)

### Display Modes
- Window mode: Uses client area of window for rendering
- Fullscreen mode: Exclusive mode with full screen buffer

## Common Modifications

### Adding New Features to Game2
1. Add UI elements to `Game2.rc` (dialogs, menus, strings)
2. Create handler classes in `Game2App.cpp` or new `.cpp` files
3. Wire up message handlers in dialog/window classes
4. Rebuild: `msbuild Game2.vcxproj /p:Configuration=Release /p:Platform=Win32`

### Modifying Video/Graphics Behavior
1. Edit `VideoServices/VideoBuffer.cpp` for display mode logic
2. Edit `VideoServices/VideoBuffer2DDraw.cpp` for 2D drawing
3. Rebuild VideoServices.dll: `msbuild VideoServices.vcxproj ...`
4. Copy to Release folder and recompile Game2.exe

### Adding DLL Dependencies
1. Ensure new DLL outputs to `c:\originalhr\HoverRace\Release\`
2. Add ProjectReference in Game2.vcxproj pointing to new DLL
3. Update AdditionalDependencies in Link settings
4. Verify DLL includes in Game2 source files

## Troubleshooting

### Build Failures

**Symptom:** "PDB file locked" or "cannot open vc143.pdb"
- **Solution:** Kill lingering compiler processes: `Get-Process cl, msbuild -ErrorAction SilentlyContinue | Stop-Process -Force`

**Symptom:** "cannot open file 'X.lib'"
- **Solution:** Ensure DLL was rebuilt and .lib file exists in Release folder

**Symptom:** "unresolved external symbol"
- **Solution:** Check ProjectReference GUID in .vcxproj matches target project GUID

### Runtime Failures

**Symptom:** Game2.exe starts but no menu bar visible
- **Solution:** Verify Game2.rc is included in resource compilation; check FIREBALL_MAIN_MENU resource exists

**Symptom:** DLL not found or cannot load
- **Solution:** Verify all DLLs are in `c:\originalhr\HoverRace\Release\` alongside Game2.exe

**Symptom:** Video mode prompt or display issues
- **Solution:** Verify VideoBuffer.cpp uses 32/16-bit color (not 8-bit); check DirectDraw initialization

## Git/Version Control

### Workflow
- Keep Release folder builds clean (outputs only, can be regenerated)
- Commit source files (.cpp, .h, .rc, .vcxproj) only
- Do not commit compiled binaries or intermediate build files

### Important Files to Commit
- `NetTarget/*/[*.cpp|*.h|*.rc|*.vcxproj]` - All source and project files
- `.copilot-instructions.md` - This file

### Files to Ignore (Add to .gitignore)
```
Release/
Debug/
NetTarget/*/Release/
NetTarget/*/Debug/
*.obj
*.lib
*.exp
*.pdb
*.ilk
*.tlog
.vs/
```

## References

### External Documentation
- DirectDraw 7 API: Legacy graphics library (replaced by Direct3D in modern systems)
- MFC Classes: Microsoft Foundation Classes for Windows UI
- Visual Studio C++ Toolset: MSVC compiler and linker

### Key Classes
- `MR_VideoBuffer` - Main video buffer and display mode manager
- `MR_Observer` - Game rendering and display handler
- `CGameApp` - Main application class (MFC CWinApp derived)

## Contact/Questions
For questions about specific components, refer to the relevant source file's comments and header documentation.

---

**Last Updated:** November 7, 2025
**Status:** Current for Release build configuration
